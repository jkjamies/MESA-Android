# Copyright 2026 Jason Jamieson
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Publish Libraries

on:
  push:
    branches: [main]
  release:
    types: [published]

jobs:
  draft-release:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Read BOM version
        id: versions
        run: |
          BOM_V=$(grep 'publishingVersion' mesa-bom/gradle.properties | cut -d'=' -f2 | tr -d '[:space:]')
          TAG="v${BOM_V}"
          echo "bom=$BOM_V" >> "$GITHUB_OUTPUT"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      - name: Delete existing draft release with same tag
        run: |
          EXISTING=$(gh release view "${{ steps.versions.outputs.tag }}" --json isDraft --jq '.isDraft' 2>/dev/null || echo "")
          if [ "$EXISTING" = "true" ]; then
            gh release delete "${{ steps.versions.outputs.tag }}" --yes
            git push --delete origin "refs/tags/${{ steps.versions.outputs.tag }}" 2>/dev/null || true
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create draft release
        run: |
          gh release create "${{ steps.versions.outputs.tag }}" \
            --draft \
            --title "MESA ${{ steps.versions.outputs.tag }}" \
            --generate-notes \
            --notes-start-tag "$(gh release list --limit 1 --exclude-drafts --json tagName --jq '.[0].tagName // empty')" \
            --target main
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  publish:
    if: github.event_name == 'release'
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write
      pull-requests: write

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Check and Publish Trapeze
        run: |
          VERSION=$(grep 'publishingVersion' trapeze/gradle.properties | cut -d'=' -f2 | tr -d '[:space:]')
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://maven.pkg.github.com/jkjamies/MESA-Android/com/jkjamies/trapeze/$VERSION/trapeze-$VERSION.pom")
          if [ "$STATUS" = "200" ]; then
            echo "::notice::trapeze:$VERSION already published, skipping"
          else
            echo "Publishing trapeze:$VERSION"
            ./gradlew :trapeze:publishReleasePublicationToGitHubPackagesRepository
          fi
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check and Publish Trapeze Navigation
        run: |
          VERSION=$(grep 'publishingVersion' trapeze-navigation/gradle.properties | cut -d'=' -f2 | tr -d '[:space:]')
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://maven.pkg.github.com/jkjamies/MESA-Android/com/jkjamies/trapeze-navigation/$VERSION/trapeze-navigation-$VERSION.pom")
          if [ "$STATUS" = "200" ]; then
            echo "::notice::trapeze-navigation:$VERSION already published, skipping"
          else
            echo "Publishing trapeze-navigation:$VERSION"
            ./gradlew :trapeze-navigation:publishReleasePublicationToGitHubPackagesRepository
          fi
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check and Publish Strata
        run: |
          VERSION=$(grep 'publishingVersion' strata/gradle.properties | cut -d'=' -f2 | tr -d '[:space:]')
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://maven.pkg.github.com/jkjamies/MESA-Android/com/jkjamies/strata/$VERSION/strata-$VERSION.pom")
          if [ "$STATUS" = "200" ]; then
            echo "::notice::strata:$VERSION already published, skipping"
          else
            echo "Publishing strata:$VERSION"
            ./gradlew :strata:publishReleasePublicationToGitHubPackagesRepository
          fi
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check and Publish MESA BOM
        run: |
          VERSION=$(grep 'publishingVersion' mesa-bom/gradle.properties | cut -d'=' -f2 | tr -d '[:space:]')
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            "https://maven.pkg.github.com/jkjamies/MESA-Android/com/jkjamies/mesa-bom/$VERSION/mesa-bom-$VERSION.pom")
          if [ "$STATUS" = "200" ]; then
            echo "::notice::mesa-bom:$VERSION already published, skipping"
          else
            echo "Publishing mesa-bom:$VERSION"
            ./gradlew :mesa-bom:publishReleasePublicationToGitHubPackagesRepository
          fi
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update CHANGELOG.md
        run: |
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          RELEASE_DATE=$(date +%Y-%m-%d)
          RELEASE_URL="${{ github.event.release.html_url }}"
          RELEASE_BODY=$(cat <<'BODY_EOF'
          ${{ github.event.release.body }}
          BODY_EOF
          )

          ENTRY="## [$RELEASE_TAG]($RELEASE_URL) - $RELEASE_DATE"$'\n\n'"$RELEASE_BODY"$'\n'

          # Insert after the marker comment
          sed -i '/<!-- Release entries will be automatically prepended below this line -->/a\' CHANGELOG.md
          sed -i "/<!-- Release entries will be automatically prepended below this line -->/r /dev/stdin" CHANGELOG.md <<< "$ENTRY"

      - name: Create CHANGELOG PR
        run: |
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          BRANCH="changelog/${RELEASE_TAG}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH" origin/main
          git add CHANGELOG.md
          git diff --cached --quiet && echo "No changelog changes" && exit 0
          git commit -m "Update CHANGELOG.md for ${RELEASE_TAG}"
          git push origin "$BRANCH"
          gh pr create \
            --title "Update CHANGELOG.md for ${RELEASE_TAG}" \
            --body "Automated changelog update from release ${RELEASE_TAG}." \
            --base main \
            --head "$BRANCH"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
